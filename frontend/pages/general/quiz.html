<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Quiz - My Study Life</title>
	<link rel="stylesheet" href="../../css/style.css">
	<link rel="stylesheet" href="../../css/quiz.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
	<script src="../../js/api.js"></script>
</head>

<body>

	<div class="topbar">
		<div class="timer" id="timerDisplay">00:00</div>
	</div>

	<div class="page">
		<div class="quiz-wrap">
			<div class="quiz-main">
				<div id="questionCard" class="question-card">
					<div class="question-number" id="questionNumber">Question 1</div>
					<div class="question-text" id="questionText">Loading...</div>

					<div class="options" id="optionsGrid"></div>

					<div class="progress-text" id="progressText">Question 0 of 0</div>

					<div class="controls">
						<div class="row">
							<button id="prevBtn" class="btn btn-prev" onclick="previousQuestion()">← Prev</button>
							<button id="nextBtn" class="btn btn-next" onclick="nextQuestion()">Next →</button>
						</div>
						<div class="actions">
							<button id="submitBtn" class="btn btn-submit" onclick="submitQuizHandler()">Submit
								Exam</button>
							<button id="clearBtn" class="btn btn-clear" onclick="clearAll()">Clear All</button>
						</div>
					</div>
				</div>
			</div>

			<aside class="quiz-side">
				<div class="side-card">
					<div class="side-title">Questions</div>
					<div id="questionList" class="qgrid"></div>
				</div>
			</aside>
		</div>
	</div>

	<!-- Results Modal -->
	<div class="results-overlay" id="resultsOverlay">
		<div class="results-card">
			<h2>Exam Completed!</h2>
			<div class="score-circle" id="resScore">0%</div>
			<div class="results-grid">
				<div class="result-item">
					<span class="result-value" id="resTotal">0</span>
					<span class="result-label">Total Qs</span>
				</div>
				<div class="result-item">
					<span class="result-value" style="color: #13b58f;" id="resCorrect">0</span>
					<span class="result-label">Correct</span>
				</div>
				<div class="result-item">
					<span class="result-value" style="color: #d83333;" id="resWrong">0</span>
					<span class="result-label">Wrong</span>
				</div>
				<div class="result-item">
					<span class="result-value" id="resAccuracy">0%</span>
					<span class="result-label">Accuracy</span>
				</div>
			</div>
			<div class="results-actions">
				<button class="btn-res btn-res-home" onclick="window.location.href='quiz_selection.html'">Back to
					Selection</button>
			</div>
		</div>
	</div>

	<script>
		let quizId = null; let quizData = null; let currentQuestionIndex = 0; let userAnswers = {}; let startTime = 0; let timerInterval = null;

		document.addEventListener('DOMContentLoaded', initQuiz);

		async function initQuiz() {
			if (!isLoggedIn()) { window.location.href = 'auth/login.html'; return; }
			const params = new URLSearchParams(window.location.search);
			quizId = params.get('id') || localStorage.getItem('currentQuizId');
			if (!quizId) { alert('No quiz selected'); window.location.href = 'quiz_selection.html'; return; }
			const res = await getQuizWithQuestions(quizId);
			if (!res.success) { alert('Failed to load quiz'); window.location.href = 'quiz_selection.html'; return; }
			quizData = res.data; startTime = Date.now();
			quizData.questions = quizData.questions || [];
			quizData.questions.forEach((_, i) => userAnswers[i] = null);
			renderQuestionList(); displayQuestion(0); startTimer();
		}

		function startTimer() {
			timerInterval = setInterval(() => {
				const s = Math.floor((Date.now() - startTime) / 1000); const m = Math.floor(s / 60); const sec = s % 60;
				document.getElementById('timerDisplay').textContent = `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
			}, 1000);
		}

		function renderQuestionList() {
			const list = document.getElementById('questionList');
			if (!quizData) { list.innerHTML = ''; return; }
			list.innerHTML = quizData.questions.map((q, i) => `<div class=\"qbtn\" id=\"qbtn-${i}\" onclick=\"displayQuestion(${i})\">${i + 1}</div>`).join('');
			updateQuestionListState();
		}

		function updateQuestionListState() {
			if (!quizData) return; quizData.questions.forEach((q, i) => {
				const el = document.getElementById('qbtn-' + i); if (!el) return; el.classList.toggle('current', i === currentQuestionIndex); el.classList.toggle('answered', !!userAnswers[i]);
			}); document.getElementById('progressText').textContent = `Question ${currentQuestionIndex + 1} of ${quizData.questions.length}`;
			document.getElementById('prevBtn').style.display = currentQuestionIndex === 0 ? 'none' : 'inline-flex';
			document.getElementById('nextBtn').style.display = currentQuestionIndex === quizData.questions.length - 1 ? 'none' : 'inline-flex';
			document.getElementById('submitBtn').style.display = currentQuestionIndex === quizData.questions.length - 1 ? 'inline-flex' : 'none';
		}

		function displayQuestion(index) {
			if (!quizData) return; if (index < 0 || index >= quizData.questions.length) return; currentQuestionIndex = index; const q = quizData.questions[index];
			document.getElementById('questionNumber').textContent = `Question ${index + 1}`;
			document.getElementById('questionText').textContent = q.question_text || '';
			const opts = [['a', q.option_a], ['b', q.option_b], ['c', q.option_c], ['d', q.option_d]];
			const grid = document.getElementById('optionsGrid'); grid.innerHTML = opts.map(o => {
				const checked = userAnswers[index] === o[0] ? 'checked' : '';
				return `<label class=\"option\" id=\"opt-${o[0]}\"><input type=\"radio\" name=\"answer\" value=\"${o[0]}\" ${checked} onchange=\"selectAnswer('${o[0]}')\"> <div>${o[1] || ''}</div></label>`;
			}).join('');
			// mark selected visually
			if (userAnswers[index]) { const sel = document.getElementById('opt-' + userAnswers[index]); if (sel) sel.classList.add('selected'); }
			updateQuestionListState(); window.scrollTo({ top: 0, behavior: 'smooth' });
		}

		function selectAnswer(val) {
			userAnswers[currentQuestionIndex] = val; // mark radio and option
			document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
			const el = document.getElementById('opt-' + val); if (el) el.classList.add('selected'); updateQuestionListState();
		}

		function previousQuestion() { if (currentQuestionIndex > 0) displayQuestion(currentQuestionIndex - 1); }
		function nextQuestion() { if (currentQuestionIndex < quizData.questions.length - 1) displayQuestion(currentQuestionIndex + 1); }

		async function submitQuizHandler() {
			clearInterval(timerInterval);
			const answers = {};
			quizData.questions.forEach((q, i) => answers[q.id] = userAnswers[i] || '');
			const res = await submitQuiz(quizId, answers);
			if (res.success) {
				showResults(res.data);
			} else {
				alert('Submit failed: ' + (res.data?.detail || 'Check console for details'));
			}
		}

		function showResults(data) {
			document.getElementById('resScore').textContent = Math.round(data.score) + '%';
			document.getElementById('resTotal').textContent = data.total;
			document.getElementById('resCorrect').textContent = data.correct;
			document.getElementById('resWrong').textContent = data.wrong;
			document.getElementById('resAccuracy').textContent = Math.round((data.correct / data.total) * 100) + '%';
			document.getElementById('resultsOverlay').classList.add('active');
		}

		function clearAll() { if (!quizData) return; quizData.questions.forEach((_, i) => userAnswers[i] = null); document.querySelectorAll('input[name="answer"]').forEach(i => i.checked = false); document.querySelectorAll('.option').forEach(o => o.classList.remove('selected')); updateQuestionListState(); }

	</script>

</body>

</html>