<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Selection - My Study Life</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/quiz_selection.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="../../js/config.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/quiz.js"></script>
    <script src="../../js/notes.js"></script>
    <script src="../../js/progress.js"></script>
    <script src="../../js/handlers.js"></script>

</head>

<body>

    <nav class="dash-nav">
        <a href="dashboard.html" class="logo">
            <i class="fa-solid fa-user-graduate"></i>
            <span>My Study Life</span>
        </a>
        <ul class="nav_links">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li id="course-nav" style="display:none;"></li>
            <li><a href="standard_materials.html">E-Books</a></li>
            <li><a href="quiz_selection.html">Quiz</a></li>
            <li><a href="my_notes.html">Notes</a></li>
            <li><a href="profile.html">Profile</a></li>
            <li><a href="../auth/logout.html" class="logout-btn">Logout</a></li>
        </ul>
    </nav>

    <div class="quiz-header">
        <h1><i class="fa-solid fa-book"></i> Quiz Selection</h1>
        <p>Choose your grade, subject and difficulty to practice</p>
    </div>

    <div class="container">
        <div class="stats-summary">
            <div class="stat-box">
                <h4>75</h4>
                <p>Total Quizzes</p>
            </div>
            <div class="stat-box">
                <h4>750</h4>
                <p>Questions</p>
            </div>
            <div class="stat-box">
                <h4>3 Levels</h4>
                <p>Easy • Medium • Hard</p>
            </div>
            <div class="stat-box">
                <h4>5 Subjects</h4>
                <p>Tamil • English • Maths • Science • SS</p>
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-group">
                <label><i class="fa-solid fa-graduation-cap"></i> Grade</label>
                <div class="filter-buttons" id="gradeFilters">
                    <button class="btn-filter active" onclick="filterQuizzes()">All</button>
                    <button class="btn-filter" onclick="filterQuizzes()">6</button>
                    <button class="btn-filter" onclick="filterQuizzes()">7</button>
                    <button class="btn-filter" onclick="filterQuizzes()">8</button>
                    <button class="btn-filter" onclick="filterQuizzes()">9</button>
                    <button class="btn-filter" onclick="filterQuizzes()">10</button>
                </div>
            </div>

            <div class="filter-group">
                <label><i class="fa-solid fa-book"></i> Subject</label>
                <div class="filter-buttons" id="subjectFilters">
                    <button class="btn-filter active" onclick="filterQuizzes()">All</button>
                    <button class="btn-filter" onclick="filterQuizzes()">Tamil</button>
                    <button class="btn-filter" onclick="filterQuizzes()">English</button>
                    <button class="btn-filter" onclick="filterQuizzes()">Maths</button>
                    <button class="btn-filter" onclick="filterQuizzes()">Science</button>
                    <button class="btn-filter" onclick="filterQuizzes()">SS</button>
                </div>
            </div>

            <div class="filter-group">
                <label><i class="fa-solid fa-chart-bar"></i> Difficulty Level</label>
                <div class="filter-buttons" id="difficultyFilters">
                    <button class="btn-filter active" onclick="filterQuizzes()">All</button>
                    <button class="btn-filter" onclick="filterQuizzes()">Easy</button>
                    <button class="btn-filter" onclick="filterQuizzes()">Medium</button>
                    <button class="btn-filter" onclick="filterQuizzes()">Hard</button>
                </div>
            </div>
        </div>

        <div id="quizGrid" class="quiz-grid"></div>
    </div>

    <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-column">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms & Condition</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Contact</h3>
                <div class="contact-info">
                    <div><i class="fa-solid fa-location-dot"></i> Chennai</div>
                    <div><i class="fa-solid fa-phone"></i> +91 9360649867</div>
                    <div><i class="fa-solid fa-envelope"></i> help@mystudylife.com</div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let allQuizzes = [];
        let selectedGrade = null;
        let selectedSubject = null;
        let selectedDifficulty = null;

        // Wrapper for API function
        async function getAllQuizzes() {
            return await getQuizzesAll();
        }

        // Initialize page
        async function initPage() {
            // Check if user is logged in
            if (!isLoggedIn()) {
                window.location.href = 'auth/login.html';
                return;
            }

            // Load all quizzes from API
            await loadQuizzesFromAPI();
            setupFilterButtons();
            renderQuizzes();
        }

        // Fetch all quizzes from API
        async function loadQuizzesFromAPI() {
            try {
                const result = await getAllQuizzes();

                if (result.success) {
                    allQuizzes = result.data.map(quiz => ({
                        id: quiz.id,
                        grade: quiz.grade,
                        subject: quiz.subject,
                        difficulty: getDifficultyLevel(quiz.title),
                        title: quiz.title,
                        questions: quiz.total_questions,
                        description: quiz.description
                    }));
                    console.log('Loaded', allQuizzes.length, 'quizzes');
                } else {
                    console.error('Failed to load quizzes:', result.error);
                    allQuizzes = [];
                }
            } catch (error) {
                console.error('Error loading quizzes:', error);
                allQuizzes = [];
            }
        }

        // Extract difficulty from title
        function getDifficultyLevel(title) {
            if (title.includes('Easy')) return 'Easy';
            if (title.includes('Medium')) return 'Medium';
            if (title.includes('Hard')) return 'Hard';
            return 'Easy';
        }

        function getActiveBtnValue(containerId) {
            const container = document.getElementById(containerId);
            const buttons = container.querySelectorAll('.btn-filter');
            let activeValue = null;
            buttons.forEach(btn => {
                if (btn.classList.contains('active') && btn.textContent !== 'All') {
                    activeValue = btn.textContent;
                }
            });
            return activeValue;
        }



        function filterQuizzes() {
            selectedGrade = getActiveBtnValue('gradeFilters');
            selectedSubject = getActiveBtnValue('subjectFilters');
            selectedDifficulty = getActiveBtnValue('difficultyFilters');
            renderQuizzes();
        }

        function renderQuizzes() {
            let filtered = allQuizzes;

            if (selectedGrade) filtered = filtered.filter(q => q.grade == selectedGrade);
            if (selectedSubject) filtered = filtered.filter(q => q.subject === selectedSubject);
            if (selectedDifficulty) filtered = filtered.filter(q => q.difficulty === selectedDifficulty);

            const subjectOrder = { 'Tamil': 1, 'English': 2, 'Maths': 3, 'Science': 4, 'SS': 5 };
            const difficultyOrder = { 'Easy': 1, 'Medium': 2, 'Hard': 3 };
            
            filtered.sort((a, b) => {
                if (a.grade !== b.grade) return a.grade - b.grade;
                if (a.subject !== b.subject) return (subjectOrder[a.subject] || 0) - (subjectOrder[b.subject] || 0);
                return (difficultyOrder[a.difficulty] || 0) - (difficultyOrder[b.difficulty] || 0);
            });

            const grid = document.getElementById('quizGrid');

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="no-results">No quizzes found. Try different filters.</div>';
                return;
            }

            grid.innerHTML = filtered.map((quiz, idx) => `
                <div class="quiz-card">
                    <h3>${quiz.title}</h3>
                    <div class="quiz-meta">
                        <div>
                            <span class="badge badge-${quiz.difficulty.toLowerCase()}">${quiz.difficulty}</span>
                        </div>
                        <div>Grade ${quiz.grade}</div>
                    </div>
                    <div class="quiz-description">${quiz.subject} | ${quiz.questions} Questions</div>
                    <div class="quiz-info">
                        <span><i class="fa-solid fa-question"></i> ${quiz.questions} Questions</span>
                        <span><i class="fa-solid fa-timer"></i> 30 mins</span>
                    </div>
                    <button class="btn-start" onclick="startQuiz(${quiz.id}, '${quiz.title}')">
                        <i class="fa-solid fa-play"></i> Start Quiz
                    </button>
                </div>
            `).join('');
        }

        function setupFilterButtons() {
            document.querySelectorAll('.filter-buttons').forEach(container => {
                const buttons = container.querySelectorAll('.btn-filter');
                buttons.forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        buttons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        filterQuizzes();
                    });
                });
            });
        }

        function startQuiz(quizId, quizTitle) {
            // Store quiz ID and redirect to quiz page
            localStorage.setItem('currentQuizId', quizId);
            localStorage.setItem('currentQuizTitle', quizTitle);
            window.location.href = 'quiz.html?id=' + quizId;
        }

        // Initialize page on load
        document.addEventListener('DOMContentLoaded', initPage);
    </script>

</body>

</html>